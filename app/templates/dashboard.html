{% extends "base.html" %}

{% block content %}
<div class="cockpit-wrap">

  <div class="cockpit-topbar">
    <div class="cockpit-title">
      <h2>AX Operations Cockpit</h2>
      <div class="cockpit-sub">
        <span class="pill">Snapshot: <b>{{ snapshot['snapshot_date'] if snapshot else '-' }}</b></span>
        <span class="pill">Month: <b>{{ selected_month if selected_month else '-' }}</b></span>
        <span class="pill">Purpose: 참여 촉진 & 운영 관리 (성과평가 목적 아님)</span>
        {% if bias_strategy %}
          <span class="badge-warn">편중 경고: {{ bias_strategy }} {{ bias_ratio }}%</span>
        {% endif %}
      </div>
    </div>

    <div class="cockpit-actions">
      <form method="get" action="/" class="filters">
        <label>스냅샷</label>
        <select class="select" name="snapshot_id" onchange="this.form.submit()">
          {% for s in snapshots %}
            <option value="{{ s['snapshot_id'] }}" {% if snapshot and s['snapshot_id'] == snapshot['snapshot_id'] %}selected{% endif %}>{{ s['snapshot_date'] }}</option>
          {% endfor %}
        </select>

        <label>월</label>
        <select class="select" name="month" onchange="this.form.submit()">
          {% for m in months %}
            <option value="{{ m }}" {% if selected_month == m %}selected{% endif %}>{{ m }}</option>
          {% endfor %}
        </select>

        <label>상태</label>
        <select class="select" name="filter_status" onchange="this.form.submit()">
          {% set statuses = ['승인(진행중)','제안','심의중','완료','보류'] %}
          {% for st in statuses %}
            <option value="{{ st }}" {% if selected_status == st %}selected{% endif %}>{{ st }}</option>
          {% endfor %}
        </select>

        <label>Champion</label>
        <select class="select" name="filter_champion" onchange="this.form.submit()">
          <option value="" {% if not selected_champion %}selected{% endif %}>전체</option>
          {% if heatmap %}
            {% for champ_name in heatmap.keys() %}
              <option value="{{ champ_name }}" {% if selected_champion == champ_name %}selected{% endif %}>{{ champ_name }}</option>
            {% endfor %}
          {% endif %}
        </select>

        <label>전략</label>
        <select class="select" name="filter_strategy" onchange="this.form.submit()">
          <option value="" {% if not selected_strategy %}selected{% endif %}>전체</option>
          {% for sname in dist_labels %}
            <option value="{{ sname }}" {% if selected_strategy == sname %}selected{% endif %}>{{ sname }}</option>
          {% endfor %}
          <option value="(미할당)" {% if selected_strategy == '(미할당)' %}selected{% endif %}>(미할당)</option>
        </select>

      </form>

      <a href="/admin">운영(업로드/관리)</a>
    </div>
  </div>

  {% if not months %}
    <div class="card">
      <div class="card-head">
        <p class="card-title">데이터 없음</p>
      </div>
      <p class="card-meta">선택한 스냅샷에 월별 탭 데이터가 없습니다. (AX_Master만 있을 수 있음)</p>
    </div>
  {% else %}

  <!-- =====================================================
       ROW 1: Trends + KPI tiles + Status donut
       ===================================================== -->
  <div class="cockpit-grid">

    <div class="card">
      <div class="card-head">
        <p class="card-title">월별 제안/승인 추이</p>
        <span class="card-meta">Snapshot 전체 기간</span>
      </div>
      <canvas id="trendChart" height="140"></canvas>
    </div>

    <div class="card">
      <div class="card-head">
        <p class="card-title">핵심 KPI</p>
        <span class="card-meta">선택 월 기준</span>
      </div>
      <div class="kpi-row">
        <div class="kpi">
          <div class="label">총 과제</div>
          <div class="value">{{ kpis.total_projects }}</div>
          <div class="hint">스냅샷 내 전체</div>
        </div>
        <div class="kpi">
          <div class="label">진행중</div>
          <div class="value">{{ kpis.total_active_projects }}</div>
          <div class="hint">승인(진행중)</div>
        </div>
        <div class="kpi">
          <div class="label">월 신규 제안</div>
          <div class="value">{{ kpis.month_proposals }}</div>
          <div class="hint">{{ selected_month }}</div>
        </div>
        <div class="kpi">
          <div class="label">월 승인</div>
          <div class="value">{{ kpis.month_approvals }}</div>
          <div class="hint">{{ selected_month }}</div>
        </div>
        <div class="kpi">
          <div class="label">Champion 참여율</div>
          <div class="value">{{ (kpis.champion_participation_rate * 100) | round(1) }}%</div>
          <div class="hint">(제안+승인>0)</div>
        </div>
        <div class="kpi">
          <div class="label">승인 전환율</div>
          <div class="value">{{ (kpis.approval_conversion_rate * 100) | round(1) }}%</div>
          <div class="hint">승인/제안</div>
        </div>
      </div>
    </div>

    <div class="card">
      <div class="card-head">
        <p class="card-title">심의상태 분포</p>
        <span class="card-meta">스냅샷 기준</span>
      </div>
      <canvas id="statusChart" height="140"></canvas>
    </div>

  </div>

  <!-- =====================================================
       ROW 2: Top 10 charts + Active (most important)
       ===================================================== -->
  <div class="cockpit-grid" style="margin-top:12px; grid-template-columns: 1.1fr 1.8fr 1.1fr;">

    <div class="card">
      <div class="card-head">
        <p class="card-title">Top 10 제안 Champion</p>
        <span class="card-meta">{{ selected_month }}</span>
      </div>
      <canvas id="topProposalChart" height="170"></canvas>
    </div>

    <div class="card">
      <div class="card-head">
        <p class="card-title">진행중 과제 리스트 (Champion별 구분)</p>
        <span class="card-meta">상태: {{ selected_status }}</span>
      </div>

      <div class="split" style="margin-bottom: 10px;">
        <div>
          <div class="card-meta" style="margin-bottom: 8px;">Champion별 진행중 수 랭킹 (클릭하면 필터 적용)</div>
          <table class="table-dark">
            <thead>
              <tr><th style="width:52px;">#</th><th>Champion</th><th style="width:90px; text-align:right;">Count</th></tr>
            </thead>
            <tbody>
              {% for champ, cnt in active_ranking %}
                <tr>
                  <td style="color:rgba(255,255,255,0.65);">{{ loop.index }}</td>
                  <td>
                    <a class="link" href="/?snapshot_id={{ snapshot['snapshot_id'] }}&month={{ selected_month }}&filter_status={{ selected_status }}&filter_champion={{ champ }}{% if selected_strategy %}&filter_strategy={{ selected_strategy }}{% endif %}">{{ champ }}</a>
                  </td>
                  <td style="text-align:right; font-weight:900;">{{ cnt }}</td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>

        <div>
          <div class="card-meta" style="margin-bottom: 8px;">리스트 (필터 적용됨)</div>
          <table class="table-dark">
            <thead>
              <tr>
                <th style="width:90px;">과제ID</th>
                <th>과제명</th>
                <th style="width:120px;">Champion</th>
                <th style="width:140px;">전략</th>
                <th style="width:110px;">상태</th>
              </tr>
            </thead>
            <tbody>
              {% for p in active_projects %}
                <tr>
                  <td style="color:rgba(255,255,255,0.70); font-weight:800;">{{ p['project_id'] }}</td>
                  <td>{{ p['project_name'] }}</td>
                  <td>{{ p['champion_name'] if p['champion_id'] else '(미할당)' }}</td>
                  <td>{{ p['strategy_name'] if p['strategy_id'] else '(미할당)' }}</td>
                  <td>{{ p['current_status'] }}</td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>

      <div class="card-meta">
        ※ 랭킹은 “성과평가”가 아니라 “AX 참여 촉진 및 운영 관리” 목적입니다. 필요 시 Champion 익명화(옵션) 가능.
      </div>
    </div>

    <div class="card">
      <div class="card-head">
        <p class="card-title">Top 10 승인 Champion</p>
        <span class="card-meta">{{ selected_month }}</span>
      </div>
      <canvas id="topApprovalChart" height="170"></canvas>
    </div>

  </div>

  <!-- =====================================================
       ROW 3: Strategy balance + Active strategy bars + monthly strategy chart
       ===================================================== -->
  <div class="cockpit-grid" style="margin-top:12px; grid-template-columns: 1.2fr 1.2fr 1.6fr;">

    <div class="card">
      <div class="card-head">
        <p class="card-title">전략분류별 진행중 분포</p>
        <span class="card-meta">Active (Snapshot)</span>
      </div>
      <canvas id="activeStrategyChart" height="170"></canvas>
    </div>

    <div class="card">
      <div class="card-head">
        <p class="card-title">전략분류별 제안/승인/진행중</p>
        <span class="card-meta">{{ selected_month }} + Active</span>
      </div>
      <canvas id="distChart" height="170"></canvas>
    </div>

    <div class="card">
      <div class="card-head">
        <p class="card-title">Champion 활동 히트맵 (제안/승인)</p>
        <span class="card-meta">스냅샷 전체</span>
      </div>
      <div style="overflow:auto; padding-bottom: 6px;">
        <table class="heatmap">
          <thead>
            <tr>
              <th style="min-width:160px;">Champion</th>
              {% for m in months %}
                <th>{{ m }}</th>
              {% endfor %}
            </tr>
          </thead>
          <tbody>
            {% for champ_name, months_data in heatmap.items() %}
              <tr>
                <th style="white-space:nowrap;">{{ champ_name }}</th>
                {% for m in months %}
                  {% set cell = months_data[m] %}
                  {% set val = cell['proposals'] + cell['approvals'] %}
                  {% set intensity = 0 %}
                  {% if max_prop + max_app > 0 %}
                    {% set intensity = (val) / (max_prop + max_app) %}
                  {% endif %}
                  {% set alpha = '%.2f' % (0.12 + (0.68 * intensity)) %}
                  <td style="background: rgba(96,165,250,{{ alpha }});">
                    <div style="font-weight:900;">{{ cell['proposals'] }}/{{ cell['approvals'] }}</div>
                    <div style="font-size:11px; color: rgba(255,255,255,0.72); margin-top:2px;">P/A</div>
                  </td>
                {% endfor %}
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>

  </div>

  <script>
  // Global chart defaults for dark cockpit
  Chart.defaults.color = 'rgba(255,255,255,0.82)';
  Chart.defaults.borderColor = 'rgba(255,255,255,0.10)';
  Chart.defaults.font.family = "ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Noto Sans KR, Arial";

  const trendMonths = {{ trend_months | tojson }};
  const trendProposals = {{ trend_proposals | tojson }};
  const trendApprovals = {{ trend_approvals | tojson }};

  const statusLabels = {{ status_labels | tojson }};
  const statusValues = {{ status_values | tojson }};

  const topPropLabels = {{ top_prop_labels | tojson }};
  const topPropValues = {{ top_prop_values | tojson }};
  const topAppLabels = {{ top_app_labels | tojson }};
  const topAppValues = {{ top_app_values | tojson }};

  const distLabels = {{ dist_labels | tojson }};
  const proposalsData = {{ proposals_data | tojson }};
  const approvalsData = {{ approvals_data | tojson }};
  const activeData = {{ active_data | tojson }};

  const activeStratLabels = {{ active_strat_labels | tojson }};
  const activeStratValues = {{ active_strat_values | tojson }};

  // 1) Trend line
  new Chart(document.getElementById('trendChart'), {
    type: 'line',
    data: {
      labels: trendMonths,
      datasets: [
        { label: '제안', data: trendProposals, tension: 0.35, borderWidth: 2, pointRadius: 2, borderColor: 'rgba(96,165,250,0.95)', backgroundColor: 'rgba(96,165,250,0.20)', fill: true },
        { label: '승인', data: trendApprovals, tension: 0.35, borderWidth: 2, pointRadius: 2, borderColor: 'rgba(167,139,250,0.95)', backgroundColor: 'rgba(167,139,250,0.18)', fill: true }
      ]
    },
    options: {
      responsive: true,
      plugins: { legend: { position: 'top', labels: { boxWidth: 10 } } },
      scales: {
        y: { beginAtZero: true, ticks: { precision: 0 } },
        x: { grid: { display: false } }
      }
    }
  });

  // 2) Status donut
  new Chart(document.getElementById('statusChart'), {
    type: 'doughnut',
    data: {
      labels: statusLabels,
      datasets: [{
        data: statusValues,
        backgroundColor: [
          'rgba(96,165,250,0.85)',
          'rgba(52,211,153,0.80)',
          'rgba(251,191,36,0.78)',
          'rgba(167,139,250,0.80)',
          'rgba(239,68,68,0.78)',
          'rgba(255,255,255,0.18)'
        ],
        borderWidth: 0
      }]
    },
    options: {
      responsive: true,
      cutout: '62%',
      plugins: { legend: { position: 'bottom' } }
    }
  });

  // 3) Top 10 Proposal
  new Chart(document.getElementById('topProposalChart'), {
    type: 'bar',
    data: {
      labels: topPropLabels,
      datasets: [{ label: '제안 건수', data: topPropValues, backgroundColor: 'rgba(96,165,250,0.55)' }]
    },
    options: {
      responsive: true,
      plugins: { legend: { display: false } },
      scales: {
        y: { beginAtZero: true, ticks: { precision: 0 } },
        x: { grid: { display: false } }
      }
    }
  });

  // 4) Top 10 Approval
  new Chart(document.getElementById('topApprovalChart'), {
    type: 'bar',
    data: {
      labels: topAppLabels,
      datasets: [{ label: '승인 건수', data: topAppValues, backgroundColor: 'rgba(167,139,250,0.55)' }]
    },
    options: {
      responsive: true,
      plugins: { legend: { display: false } },
      scales: {
        y: { beginAtZero: true, ticks: { precision: 0 } },
        x: { grid: { display: false } }
      }
    }
  });

  // 5) Strategy distribution (clustered)
  new Chart(document.getElementById('distChart'), {
    type: 'bar',
    data: {
      labels: distLabels,
      datasets: [
        { label: '제안', data: proposalsData, backgroundColor: 'rgba(96,165,250,0.45)' },
        { label: '승인', data: approvalsData, backgroundColor: 'rgba(167,139,250,0.45)' },
        { label: '진행중', data: activeData, backgroundColor: 'rgba(52,211,153,0.45)' }
      ]
    },
    options: {
      responsive: true,
      plugins: { legend: { position: 'top', labels: { boxWidth: 10 } } },
      scales: { y: { beginAtZero: true, ticks: { precision: 0 } }, x: { grid: { display: false } } }
    }
  });

  // 6) Active by strategy (horizontal bar)
  new Chart(document.getElementById('activeStrategyChart'), {
    type: 'bar',
    data: {
      labels: activeStratLabels,
      datasets: [{ label: '진행중', data: activeStratValues, backgroundColor: 'rgba(52,211,153,0.55)' }]
    },
    options: {
      indexAxis: 'y',
      responsive: true,
      plugins: { legend: { display: false } },
      scales: {
        x: { beginAtZero: true, ticks: { precision: 0 } },
        y: { grid: { display: false } }
      }
    }
  });
  </script>

  {% endif %}

</div>
{% endblock %}
